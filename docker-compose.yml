services:
  # Honeypot Cowrie
  cowrie:
    image: cowrie/cowrie:latest
    container_name: cowrie
    ports:
      - "2222:2222"  # SSH
      - "2223:2223"  # Telnet (optionnel)
    volumes:
      # Volume pour les logs - ATTENTION au chemin exact dans Cowrie
      - cowrie_logs:/cowrie/var/log/cowrie
    networks:
      - pysec_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "test", "-f", "/cowrie/var/log/cowrie/cowrie.json"]
      interval: 5s
      timeout: 3s
      retries: 10

  # NIDS (Network Intrusion Detection System)
  nids:
    build:
      context: ./nids
      dockerfile: Dockerfile
    container_name: nids
    volumes:
      - cowrie_logs:/cowrie_logs:ro  # Lecture seule des logs Cowrie
      - ./nids/logs:/app/logs
    networks:
      - pysec_network
    depends_on:
      cowrie:
        condition: service_healthy
    restart: unless-stopped
    command: python -u nids.py

  # Attacker (script de pentest)
  attacker:
    build:
      context: ./attacker
      dockerfile: Dockerfile
    container_name: attacker
    volumes:
      - ./attacker/logs:/app/logs
    networks:
      - pysec_network
    depends_on:
      - cowrie
      - nids
    # Ne d√©marre pas automatiquement
    profiles:
      - manual

networks:
  pysec_network:
    driver: bridge

volumes:
  cowrie_logs: